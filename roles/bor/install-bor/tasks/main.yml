---
# tasks file for bor

- name: install bor pacakges and bor profile
  shell: curl -L https://raw.githubusercontent.com/shibaone/install/puppynet/bor.sh | bash -s -- {{ bor_version }} {{ network }} {{ node_type }}
  become: true

- name: uncomment p2p discovery
  shell: sed -i 's|.*\[p2p.discovery\]|  \[p2p.discovery\] |g' /var/lib/bor/config.toml
  become: true

- name: make bor the user of data directory
  shell: chown bor /var/lib/bor
  become: true

- name: add shibarium bootnodes
  shell: sed -i 's|.*bootnodes =.*|    bootnodes = ["enode://1711a371c7ae1c1f029d0c3eb58d7e875901ee9990dafe6969f86027cca7fa462455be641560a1e25dd09138cf57163c7c19d784247874f60b2a206b61a03e2b@44.204.200.100:30303", "enode://1efa5518ab2515b6fbbe1dc99b8bede1bf8fa373e2753e0819369e711ba0f56f00d71b17ca85ba3a56c4909cc7b1cf65ca2f53bfc483542a93bc67318dfdfa45@18.136.201.99:30303", "enode://d97215a5e3cff60e3f001aa2c91bed2d28101e7513681abe1254a667c4232ccd9143985f3225a3f86c8247cf3c91a355ec2a2cfea500ea203014e625a2aee2a7@3.99.233.157:30303", "enode://03d5616779bc4109bcfa8cea10423411f1c2872f26b49863cfadc4fde88f0bdf7a56ef31d1ec9699b3a54342013d257184cd9b9480cf632a32b458cd7b6e2a6a@63.32.53.219:30303", "enode://455c8e9776cf35592b528cb046d56400ff361b1ca9ce833205e4dc41e45bdf7fbc5e50dfd147037f7357a7115169a461dae2474f50697771871febb00ee2974f@52.12.214.141:30303"]|g' /var/lib/bor/config.toml
  when: network == "shibarium"
  become: true

- name: add puppynet bootnodes
  shell: sed -i 's|.*bootnodes =.*|    bootnodes = ["enode://30da2a73104d66f4f8a8af2bf73e1574c703df277de79fac909743cccfab8f93bcf0d4149bdedd26221400b232da52ff6a5cb22146241f7a62b70267048a8c52@34.228.222.213:30303", "enode://88667acbaa709d6f1146043ecd7df6c0a124849db56496e9587d3d80d87b3c14759c10e6c37f689be6a04cda7e323805d33b0b68d48f97faf7682691f8bd371a@18.143.185.174:30303", "enode://2eeab8780edcd72f650a94fd9232fa7ca08d016724fb92cf3a44049532bde2afbb837712b8b63526173e788da89df6e9620818343f32e0c72e3a1ba986ca12bd@3.99.174.151:30303", "enode://0091347d3850d795b8a8baa3cbe75ee7b2190f84e9ff3191af1b4ad019aa8e2c7d3fc131a6010e0e13d51ef85daf98b8589b530ce499a05c032abeb6a861faf0@3.254.67.220:30303"]|g' /var/lib/bor/config.toml
  when: network == "puppynet"
  become: true

- name: add puppynet static-nodes
  shell: sed -i 's|.*static-nodes =.*|   static-nodes = ["enode://30da2a73104d66f4f8a8af2bf73e1574c703df277de79fac909743cccfab8f93bcf0d4149bdedd26221400b232da52ff6a5cb22146241f7a62b70267048a8c52@34.228.222.213:30303", "enode://88667acbaa709d6f1146043ecd7df6c0a124849db56496e9587d3d80d87b3c14759c10e6c37f689be6a04cda7e323805d33b0b68d48f97faf7682691f8bd371a@18.143.185.174:30303", "enode://2eeab8780edcd72f650a94fd9232fa7ca08d016724fb92cf3a44049532bde2afbb837712b8b63526173e788da89df6e9620818343f32e0c72e3a1ba986ca12bd@3.99.174.151:30303", "enode://0091347d3850d795b8a8baa3cbe75ee7b2190f84e9ff3191af1b4ad019aa8e2c7d3fc131a6010e0e13d51ef85daf98b8589b530ce499a05c032abeb6a861faf0@3.254.67.220:30303" ]|g' /var/lib/bor/config.toml
  when: network == "puppynet"
  become: true

- name: add shibarium static-nodes
  shell: sed -i 's|.*static-nodes =.*|   static-nodes = [ "enode://1711a371c7ae1c1f029d0c3eb58d7e875901ee9990dafe6969f86027cca7fa462455be641560a1e25dd09138cf57163c7c19d784247874f60b2a206b61a03e2b@44.204.200.100:30303", "enode://1efa5518ab2515b6fbbe1dc99b8bede1bf8fa373e2753e0819369e711ba0f56f00d71b17ca85ba3a56c4909cc7b1cf65ca2f53bfc483542a93bc67318dfdfa45@18.136.201.99:30303", "enode://d97215a5e3cff60e3f001aa2c91bed2d28101e7513681abe1254a667c4232ccd9143985f3225a3f86c8247cf3c91a355ec2a2cfea500ea203014e625a2aee2a7@3.99.233.157:30303", "enode://03d5616779bc4109bcfa8cea10423411f1c2872f26b49863cfadc4fde88f0bdf7a56ef31d1ec9699b3a54342013d257184cd9b9480cf632a32b458cd7b6e2a6a@63.32.53.219:30303", "enode://455c8e9776cf35592b528cb046d56400ff361b1ca9ce833205e4dc41e45bdf7fbc5e50dfd147037f7357a7115169a461dae2474f50697771871febb00ee2974f@52.12.214.141:30303" ]|g' /var/lib/bor/config.toml
  when: network == "shibarium"
  become: true

- name: add values to the maxpeers value
  ansible.builtin.lineinfile:
    path: /var/lib/bor/config.toml
    regexp: '^\s*maxpeers =.*$'
    line: '\t maxpeers = 50'
    backrefs: yes
  when: node_type == "sentry" or "archive"
  become: true

- name: add values to the max peers value
  ansible.builtin.lineinfile:
    path: /var/lib/bor/config.toml
    regexp: '^\s*maxpeers =.*$'
    line: '\t maxpeers = 20'
    backrefs: yes
  when: node_type == "validator"
  become: true

- name: add values for max peers for bootnode
  ansible.builtin.lineinfile:
    path: /var/lib/bor/config.toml
    regexp: '^\s*maxpeers =.*$'
    line: '\t maxpeers = 200'
    backrefs: yes
  when: node_type == "bootnode"
  become: true

- name: start bor service
  systemd:
    state: restarted
    daemon-reload: yes
    name: bor.service
  become: true